
name: YamDB Django-app

on:
  push:
    branches:
      - master

env:
  IMAGE_NAME: yamdb_final

jobs:
  tests:
    name: Ğ¢ĞµÑÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°.
    runs-on: ubuntu-latest
    steps:
      - name: ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ.
        uses: actions/checkout@v3
      
      - name: Ğ Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Python.
        uses: actions/setup-python@v4
        with:
          python-version: 3.7

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹.
        run: | 
          python -m pip install --upgrade pip 
          pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
          pip install -r ./api_yamdb/requirements.txt  

      - name: Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ² flake8
        run: python -m flake8

      - name: Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ² Pytest
        run: pytest tests

  build_and_push_to_docker_hub:
    name: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ½Ğ° DockerHub.
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ DockerHub.
        uses: actions/checkout@v3 
      
      - name: Ğ’Ñ‹Ğ·Ğ¾Ğ² ÑĞ±Ğ¾Ñ€Ñ‰Ğ¸ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² docker.
        uses: docker/setup-buildx-action@v2

      - name: ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ° DockerHub
        uses: docker/login-action@v2 
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ½Ğ° DockerHub.
        uses: docker/build-push-action@v4 
        with:
          file: ./api_yamdb/Dockerfile
          push: true
          tags: v1ncento/${{ env.IMAGE_NAME }}:latest
          # $(echo $GITHUB_SHA | head -c7)


  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
      - name: Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… ssh-ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            sudo docker-compose stop
            sudo docker-compose rm web
            touch .env
            echo DB_ENGINE=${{ secrets.DB_ENGINE }} >> .env
            echo DB_NAME=${{ secrets.DB_NAME }} >> .env
            echo POSTGRES_USER=${{ secrets.POSTGRES_USER }} >> .env
            echo POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} >> .env
            echo DB_HOST=${{ secrets.DB_HOST }} >> .env
            echo DB_PORT=${{ secrets.DB_PORT }} >> .env
            sudo docker-compose up -d
            
  send_message:
    name: âœ‰
    runs-on: ubuntu-latest
    needs: deploy
    steps:
    - name: Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ¢Ğ“
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: ğŸ‰ ${{ github.workflow }} â˜‘ï¸